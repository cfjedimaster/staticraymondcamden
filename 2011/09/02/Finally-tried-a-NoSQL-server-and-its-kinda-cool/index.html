<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>Finally tried a NoSQL server... and it&#39;s kinda cool &middot; Raymond Camden</title>
    <meta name="generator" content="Hugo 0.15" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="Raymond Camden">
    
      <meta name="description" content="">
    
	<link href="http://feeds.feedburner.com/raymondcamdensblog" rel="alternate" type="application/rss+xml" title="Raymond Camden" />
	<link href="http://feeds.feedburner.com/raymondcamdensblog" rel="feed" type="application/rss+xml" title="Raymond Camden" />
    <link rel="icon" href="http://www.raymondcamden.com/favicon.ico">
    <link rel="apple-touch-icon" href="http://www.raymondcamden.com/apple-touch-icon.png" />
    <link rel="stylesheet" href="http://www.raymondcamden.com/css/style.css">
    <link rel="stylesheet" href="http://www.raymondcamden.com/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://www.raymondcamden.com/css/monokai.css">
    <link rel="stylesheet" href="http://www.raymondcamden.com/fancybox/jquery.fancybox.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="http://www.raymondcamden.com/css/prism.css" />
	<link rel="stylesheet" href="http://www.raymondcamden.com/css/custom.css" />
	
    <meta property="og:title" content="Finally tried a NoSQL server... and it&#39;s kinda cool" />
<meta property="og:description" content="About a year or so ago I was lucky enough to catch a presentation from Marc Esher where he discussed NoSQL and MongoDB in particular. I found it interesting - but I filed it away as one of those cool technologies that I probably wouldn&rsquo;t ever have a good reason to actually use. Fast forward a year or so and I found myself thinking more about OpenAmplify and their API. Readers here know I&rsquo;ve done a few blog posts on their text analysis API. One of the things I normally mention in my posts is that their API could be critical for a site that contains a lot of user generated content. It occurred to me that I know a site like that&hellip; this one.



Now - my blog does not get a lot of traffic in the grand scheme of things. But I have been running it for over 9 years. So while I don&rsquo;t get a lot of content every day (I average 12 or so comments per day), I do have a large set of data to look at (44000&#43; comments). As an experiment, I thought it would be interesting to run OpenAmplify against all 44000&#43; comments and see what kind of text analysis I could get from it. This quest involved two main aspects:




Getting the analysis. OpenAmplify has an incredibly simple API. Basically send it text and get stuff back. This part I wasn&#39;t worried about.
Report on stats. So that would be easy - once I have my data stored. Right?

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.raymondcamden.com/2011/09/02/Finally-tried-a-NoSQL-server-and-its-kinda-cool" />


<meta property="og:updated_time" content="2011-09-02T12:09:00&#43;06:00"/>










    
    
<meta itemprop="name" content="Finally tried a NoSQL server... and it&#39;s kinda cool">
<meta itemprop="description" content="About a year or so ago I was lucky enough to catch a presentation from Marc Esher where he discussed NoSQL and MongoDB in particular. I found it interesting - but I filed it away as one of those cool technologies that I probably wouldn&rsquo;t ever have a good reason to actually use. Fast forward a year or so and I found myself thinking more about OpenAmplify and their API. Readers here know I&rsquo;ve done a few blog posts on their text analysis API. One of the things I normally mention in my posts is that their API could be critical for a site that contains a lot of user generated content. It occurred to me that I know a site like that&hellip; this one.



Now - my blog does not get a lot of traffic in the grand scheme of things. But I have been running it for over 9 years. So while I don&rsquo;t get a lot of content every day (I average 12 or so comments per day), I do have a large set of data to look at (44000&#43; comments). As an experiment, I thought it would be interesting to run OpenAmplify against all 44000&#43; comments and see what kind of text analysis I could get from it. This quest involved two main aspects:




Getting the analysis. OpenAmplify has an incredibly simple API. Basically send it text and get stuff back. This part I wasn&#39;t worried about.
Report on stats. So that would be easy - once I have my data stored. Right?

">


<meta itemprop="dateModified" content="2011-09-02T12:09:00&#43;06:00" />
<meta itemprop="wordCount" content="2311">



<meta itemprop="keywords" content="adoption,books,coldfusion,design,development,flex,games,html5,javascript,jquery,misc,mobile,movies,music,uncategorized,video-games,bluemix,cordova,front-end-interview-questions,harpjs,ionic,mobilefirst,nodejs,phonegap,strongloop,swift," />

    

  <meta name="twitter:card" content="summary"/>



<meta name="twitter:title" content="Finally tried a NoSQL server... and it&#39;s kinda cool"/>
<meta name="twitter:description" content="About a year or so ago I was lucky enough to catch a presentation from Marc Esher where he discussed NoSQL and MongoDB in particular. I found it interesting - but I filed it away as one of those cool technologies that I probably wouldn&rsquo;t ever have a good reason to actually use. Fast forward a year or so and I found myself thinking more about OpenAmplify and their API. Readers here know I&rsquo;ve done a few blog posts on their text analysis API. One of the things I normally mention in my posts is that their API could be critical for a site that contains a lot of user generated content. It occurred to me that I know a site like that&hellip; this one.



Now - my blog does not get a lot of traffic in the grand scheme of things. But I have been running it for over 9 years. So while I don&rsquo;t get a lot of content every day (I average 12 or so comments per day), I do have a large set of data to look at (44000&#43; comments). As an experiment, I thought it would be interesting to run OpenAmplify against all 44000&#43; comments and see what kind of text analysis I could get from it. This quest involved two main aspects:




Getting the analysis. OpenAmplify has an incredibly simple API. Basically send it text and get stuff back. This part I wasn&#39;t worried about.
Report on stats. So that would be easy - once I have my data stored. Right?

"/>
<meta name="twitter:site" content="@raymondcamden"/>


</head>
<body>
<div class="container">

<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="http://www.raymondcamden.com/" id="logo"><i class="logo" style="background-image: url('http://www.raymondcamden.com/css/images/logo.png')"></i><span class="site-title">Raymond Camden</span></a>
      <nav id="main-nav">
          
          
          <a class="main-nav-link" href="http://www.raymondcamden.com/">Home</a>
          
          
          
          
          
          
          
          

          

          
          
          
          
          <a class="main-nav-link" href="http://www.raymondcamden.com/about/">About Me</a>
          
          
          
          <a class="main-nav-link" href="http://www.raymondcamden.com/speaking/">Speaking Engagements</a>
          
          
          
          <a class="main-nav-link" href="http://www.raymondcamden.com/contact/">Contact</a>
          
          
      </nav>
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="http://www.raymondcamden.com//images/avatar.jpg"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
        <div id="search-form-wrap">
          <form action="http://www.raymondcamden.com/search/" method="get" accept-charset="UTF-8" class="search-form">
              <input type="search" name="q" results="0" class="search-form-input" placeholder="Search">
              <button type="submit" class="search-form-submit">
              </button>
         </form>
        </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tbody>
          <tr>
          
          
          <td><a class="main-nav-link" href="http://www.raymondcamden.com/">Home</a></td>
          
          
          
          
          
          
          
          

          

          
          
          
          
          <td><a class="main-nav-link" href="http://www.raymondcamden.com/about/">About Me</a></td>
          
          
          
          <td><a class="main-nav-link" href="http://www.raymondcamden.com/speaking/">Speaking Engagements</a></td>
          
          
          
          <td><a class="main-nav-link" href="http://www.raymondcamden.com/contact/">Contact</a></td>
          
          
          <td>
          <form action="http://www.raymondcamden.com/search/" method="get" accept-charset="UTF-8" class="search-form">
          <input type="search" name="q" results="0" class="search-form-input" placeholder="Search">
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</header>


<div id="container">
   <div class="outer">
    <aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="http://www.raymondcamden.com//images/avatar.jpg">
      <h2 id="name">Raymond Camden</h2>
      <h3 id="title">Developer Advocate for IBM</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Earth</span>
      
          <a id="follow" href="https://twitter.com/raymondcamden">
              Follow
          </a>
      
    </div>
    <div class="article-info profile-block">
	  
      <div class="article-info-block">
        5647
        <span>Posts</span>
      </div>
      <div class="article-info-block">
        
          10
          
        <span>
            Tags
        </span>
      </div>
	  
    </div>
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
          
<td><a href="//github.com/cfjedimaster" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>





















<td><a href="//youtube.com/theraymondcamden" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>





























<td><a href="//twitter.com/raymondcamden" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>


          <td><a href="http://feeds.feedburner.com/raymondcamdensblog" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td>
        </tr>
      </table>
    </div>
  </div>


	<div class="widget-wrap">
		<div class="widget">

	<a href="http://www.slatwallcommerce.com/lp/coldfusion-ecommerce/?utm_source=Raymond%20Camden%20Blog&utm_medium=display&utm_content=Open%20Source%20ColdFusion%20eCommerce%20Platform&utm_campaign=ColdFusion%20eCommerce">
		<img src="/images/rcblog.png" class="centered">
	</a>
		</div>
	</div>

</aside>

    
<section id="main">
    <article id="page-undefined" class="article article-type-page" itemscope="" itemprop="blogPost">

		

		<p><a href="https://hostek.com/hosting/coldfusion/vps/coldfusion-vps-hosting.html">
			<img src="/images/ray-ad.jpg" class="centered" style="margin-bottom:10px">
		</a></p>

		

        <div class="article-inner">
            

            <header class="article-header">
    <a href="http://www.raymondcamden.com/2011/09/02/Finally-tried-a-NoSQL-server-and-its-kinda-cool">
    <h1 class="article-title" itemprop="name">
        Finally tried a NoSQL server... and it&#39;s kinda cool
    </h1>
    </a>
    <div class="article-meta">
		
        <div class="article-date">
            <i class="fa fa-calendar"></i>
            <time datetime="2011-09-02 12:09:00 &#43;0600 &#43;0600" itemprop="datePublished">2011-09-02</time>
        </div>
		
        
        
            
            
            <div class="article-category">
                <i class="fa fa-folder"></i>
                
                <a class="article-category-link" href="http://www.raymondcamden.com/categories/coldfusion">ColdFusion</a>
                
                
            </div>
            
        

        
            
            
        
    </div>
</header>

            <div class="article-entry" itemprop="articleBody" style="padding-bottom:10px">
                <p>About a year or so ago I was lucky enough to catch a presentation from Marc Esher where he discussed NoSQL and <a href="http://www.mongodb.org/">MongoDB</a> in particular. I found it interesting - but I filed it away as one of those cool technologies that I probably wouldn&rsquo;t ever have a good reason to actually use. Fast forward a year or so and I found myself thinking more about <a href="http://www.openamplify.com/">OpenAmplify</a> and their API. Readers here know I&rsquo;ve done a few blog posts on their text analysis API. One of the things I normally mention in my posts is that their API could be critical for a site that contains a lot of user generated content. It occurred to me that I know a site like that&hellip; this one.</p>

<p><p/></p>

<p>Now - my blog does not get a lot of traffic in the grand scheme of things. But I have been running it for over 9 years. So while I don&rsquo;t get a lot of content every day (I average 12 or so comments per day), I do have a large set of data to look at (44000+ comments). As an experiment, I thought it would be interesting to run OpenAmplify against <b>all 44000+</b> comments and see what kind of text analysis I could get from it. This quest involved two main aspects:</p>

<p><p/></p>

<ol>
<li>Getting the analysis. OpenAmplify has an <i>incredibly</i> simple API. Basically send it text and get stuff back. This part I wasn't worried about.
<li>Report on stats. So that would be easy - once I have my data stored. Right?
</ol>

<p><p></p>

<p>Turned out the second item was a bit difficult. When you send your text to OpenAmplify, you get a lot of data back. I mean a <b>lot</b> of data. How big? Check out this screen shot. It&rsquo;s a portion of the result. If you click it, it will take you to a 1 meg picture of the entire cfdump.</p>

<p><p></p>

<p><a href="http://www.raymondcamden.com/images/biggestdumpever.png"><img src="http://www.coldfusionjedi.com/images/biggestdumpever_small.png" title="Click me for the largest struct ever."></a></p>

<p><p></p>

<p>So the immediate issue I had was&hellip; how do I store this? Storing a structure into a database isn&rsquo;t impossible. You can simply flatten it. So a struct like so:</p>

<p><p></p>

<p><img src="http://www.coldfusionjedi.com/images/ScreenClip171.png" /></p>

<p><p></p>

<p>Could be stored into a database table with these columns: age, gender, name_firstname, and name_lastname. But that struct was simple. What happens when you deeply nested structs? Arrays? Or the monster you see above. You get the idea. We&rsquo;ve got a storage problem. Enter MongoDB.</p>

<p><p></p>

<p>One of the most interesting aspects of the NoSQL space is that they allow you to arbitrarily store complex data. That&rsquo;s what I was told anyway. I thought I&rsquo;d take a look at how real that claim was. I began by downloading MongoDB and setting it up. Their <a href="http://www.mongodb.org/display/DOCS/Home">docs</a> are really well done and they have specific instructions for each operating system. I was up and running in about five minutes. Next is the ColdFusion aspect. For a while now Marc Esher has worked on a wrapper for MongoDB called <a href="https://github.com/marcesher/cfmongodb">CFMongoDB</a>. (He really should come up with some kind of a neater name. Maybe something with Cold in it!) I downloaded his code as well and took it for a spin. I had his sample code up and running rather quickly so installation of the bits was no longer a problem.</p>

<p><p></p>

<p>Ok - so let&rsquo;s back up a bit and talk about the process. I began by creating a CFM script that I could schedule. It would take a few hundred blog comments that had not yet been processed, run OpenAmplify on them, and store the result as a JSON string to the database. Here is that script:</p>

<p><p></p>

<p><code>
&lt;cfsetting requesttimeout=&ldquo;999&rdquo;&gt;
&lt;cfset dsn = &ldquo;myblog&rdquo;&gt;
&lt;cfset oakey = &ldquo;moo&rdquo;&gt;</p>

<p>&lt;!&mdash; get total count &mdash;&gt;
&lt;cfquery name=&ldquo;getCommentCount&rdquo; datasource=&ldquo;#dsn#&rdquo;&gt;
select count(id) as total
from    tblblogcomments
&lt;/cfquery&gt;</p>

<p>&lt;cfoutput&gt;
There are #numberFormat(getCommentCount.total)# comments.&lt;br/&gt;
&lt;/cfoutput&gt;</p>

<p>&lt;!&mdash; get what we need to analyze &mdash;&gt;
&lt;cfquery name=&ldquo;getCommentCount&rdquo; datasource=&ldquo;#dsn#&rdquo;&gt;
select count(id) as total
from    tblblogcomments
where   analysis is null
&lt;/cfquery&gt;</p>

<p>&lt;cfoutput&gt;
There are #numberFormat(getCommentCount.total)# comments to be analyzed.&lt;br/&gt;
&lt;/cfoutput&gt;
&lt;cfflush&gt;</p>

<p>&lt;!&mdash; get a sub set &mdash;&gt;
&lt;cfquery name=&ldquo;getComments&rdquo; datasource=&ldquo;#dsn#&rdquo;&gt;
select  id, comment
from    tblblogcomments
where   analysis is null
and     comment is not null and comment != &ldquo;
limit 0,600
&lt;/cfquery&gt;
&lt;cfset oa = new openamplify(oakey)&gt;</p>

<p>&lt;cfloop query=&ldquo;getComments&rdquo;&gt;
    &lt;cftry&gt;
        &lt;cfset analysis = oa.parse(text=comment,analysis=&ldquo;all&rdquo;)&gt;
        &lt;cfset json = serializeJSON(analysis)&gt;
        &lt;cfquery datasource=&ldquo;#dsn#&rdquo;&gt;
        update tblblogcomments
        set analysis = &lt;cfqueryparam cfsqltype=&ldquo;cf_sql_longvarchar&rdquo; value=&ldquo;#json#&rdquo;&gt;
        where id = &lt;cfqueryparam cfsqltype=&ldquo;cf_sql_varchar&rdquo; value=&ldquo;#id#&rdquo;&gt;
        &lt;/cfquery&gt;
        &lt;cfif currentRow mod 10 is 0&gt;
            &lt;cfoutput&gt;Processed row #currentRow#&lt;br/&gt;&lt;cfflush&gt;&lt;/cfoutput&gt;
        &lt;/cfif&gt;
        &lt;cfcatch&gt;
            &lt;cfoutput&gt;Skipped #id# because: #cfcatch.message#&lt;br/&gt;&lt;/cfoutput&gt;
            &lt;!&mdash; todo - save as {}? &mdash;-&gt;
        &lt;/cfcatch&gt;
    &lt;/cftry&gt;
&lt;/cfloop&gt;</p>

<p>&lt;cfoutput&gt;
&lt;p&gt;
Done. Processed #getComments.recordCount# items.
&lt;/cfoutput&gt;
</code></p>

<p><p></p>

<p>So why did I store the string in the database? I wanted a temporary solution while I was still learning MongoDB. I also knew it would take a few days to process all 44K entries. The OpenAmplify folks were kind enough to give me an increase in my usage, but I still planned for this to run over a week. (I believe it only took 3 days though.) Essentially I used the database here as a simple storage place for large JSON strings.</p>

<p><p></p>

<p>The flip side then was to take that JSON and store it into MongoDB. MongoDB takes any data, right?</p>

<p><p></p>

<p><code>
&lt;cfsetting requesttimeout=&ldquo;999&rdquo;&gt;
&lt;cfscript&gt;
    dbName = &ldquo;deepcomment&rdquo;;
    javaloaderFactory = createObject(&lsquo;component&rsquo;,&lsquo;cfmongodb.core.JavaloaderFactory&rsquo;).init();
    mongoConfig = createObject(&lsquo;component&rsquo;,&lsquo;cfmongodb.core.MongoConfig&rsquo;).init(dbName=dbName, mongoFactory=javaloaderFactory);
    mongo = createObject(&lsquo;component&rsquo;,&lsquo;cfmongodb.core.Mongo&rsquo;).init(mongoConfig);</p>

<pre><code>collectionName = &quot;comments&quot;;
comments = mongo.getDBCollection( collectionName );

//wipe out and start over
comments.remove({});

numComments = comments.count();

//get comments with analysis
q = new com.adobe.coldfusion.query();    
q.setDatasource(&quot;myblog&quot;);    
q.setSQL(&quot;select id, entryidfk, name, email, comment, analysis, posted from tblblogcomments where analysis is not null&quot;);    
commentQuery = q.execute().getResult();

writeOutput(&quot;Found #numberFormat(numComments)# comments&amp;lt;br&amp;gt;&quot;);
writeOutput(&quot;Found #numberFormat(commentQuery.recordCount)# comments in the database&amp;lt;br&amp;gt;&quot;);


//populate the articles collection if we need to
if( commentQuery.recordCount gt 0 ){
    all = [];

    for( i = 1; i LTE commentQuery.recordCount; i++){

        comment = {
            id=commentQuery.id[i], 
            entryidfk=commentQuery.entryidfk[i],
            name=commentQuery.name[i],
            email=commentQuery.email[i],
            posted=commentQuery.posted[i],
            analysis=deserializeJSON(commentQuery.analysis[i])
            };
        arrayAppend( all, comment );

        if(i mod 1000 == 0) {
            comments.saveAll( all );
            all = [];
            writelog(file=&quot;application&quot;,text=&quot;inserted #i#, #arrayLen(all)#&quot;);
        }

    }

    comments.saveAll( all );
    writeOutput(&quot;inserted #i-1# comments&amp;lt;br&amp;gt;&quot;);
}

//get an idea of what the data look like
first = comments.find(sort={&quot;ID&quot;=-1},limit=5);
writeDump( var=first.asArray(), label=&quot;first 5 comments&quot;, expand=&quot;false&quot; );

mongo.close();
</code></pre>

<p>&lt;/cfscript&gt;
</code></p>

<p><p></p>

<p>If you&rsquo;ve never seen any MongoDB (or CFMongoDB) code before, let me explain it. (And let me be very clear here. I&rsquo;m new to this whole area. If I screw anything up here terminology wise, I apologize in advance!) I begin by initializing the CFMongoDB wrappers. That would normally be within an Application.cfc (and in fact, I moved it a bit later). But you can think of that as simply the setup of the connection between ColdFusion and MongoDB. By the way, MongoDB suffers from the same serious fault as ColdFusion. It doesn&rsquo;t work well if you forget to run it. Yes - I did that a lot.</p>

<p><p></p>

<p>I created an arbitrary collection to store my data and called it comments. The remove function there was used because my code was nuking and recreating while I tested. You do not have to do this in production. (And should not I assume.)</p>

<p><p></p>

<p>Next I ran a query to get my comments (the one with analysis). I loop over the results and for each one, I create a structure that contains information about the comment as well as the deserialized analysis structure from OpenAmplify. This struct is added to an array which then gets passed to MongoDB.</p>

<p><p></p>

<p>And it worked. Just like that. That ginourmous set of data just&hellip; got stored. I didn&rsquo;t have to translate it to a table at all. The only real issue I ran into was memory management. You can see I nuke the array every 1000 items. That was ColdFusion/RAM related, not MongoDB&rsquo;s fault.</p>

<p><p></p>

<p>Finally at the end there you can see me getting a set of data just to look at and ensure things are kosher. &ldquo;Getting&rdquo; stuff is where things get interesting.</p>

<p><p></p>

<p>So - MongoDB supports a few interesting ways to fetch your data. You can do a find command based on a key. So for example, here is one example of that:</p>

<p><p></p>

<p><code>
 var cursor=db.comments.find({&ldquo;ANALYSIS.Topics.TopTopics.Topic.Name&rdquo;:&ldquo;grid&rdquo;})
</code></p>

<p><p></p>

<p>That long key name there is straight from OpenAmplify. MongoDB knows then to search for this particular key in the data and also handles the fact that not every instance will have that key. You can do distinct counts. You can do counts. You can get and sort. There&rsquo;s an interesting <a href="http://www.mongodb.org/display/DOCS/SQL+to+Mongo+Mapping+Chart">SQL to Mongo</a> chart that gives a lot of examples of this. Once you wrap your head around it, it almost feels a bit more natural than SQL. Here is an example that allows me to enter a keyword and get a report on how many times it showed up in comments:</p>

<p><p></p>

<p><code>
&lt;cfparam name=&ldquo;form.keyword&rdquo; default=&ldquo;&rdquo;&gt;</p>

<p>&lt;cfoutput&gt;
&lt;form method=&ldquo;post&rdquo;&gt;
    Keyword: &lt;input type=&ldquo;text&rdquo; name=&ldquo;keyword&rdquo; value=&ldquo;#form.keyword#&rdquo;&gt; &lt;input type=&ldquo;submit&rdquo; value=&ldquo;Look Up&rdquo; /&gt;
&lt;/form&gt;
&lt;/cfoutput&gt;</p>

<p>&lt;cfif len(trim(form.keyword))&gt;
    &lt;cfset comments = application.mongo.getDBCollection(application.collectionName)&gt;
    &lt;cfset criteria = { &ldquo;ANALYSIS.Topics.TopTopics.Topic.Name&rdquo;=form.keyword}&gt;</p>

<pre><code>&amp;lt;!--- case sensitive ---&amp;gt;
&amp;lt;!---
&amp;lt;cfset res = comments.count(criteria=criteria)&amp;gt;
---&amp;gt;
&amp;lt;cfset res = comments.query().regex(&quot;ANALYSIS.Topics.TopTopics.Topic.Name&quot;,&quot;(?i)#form.keyword#&quot;).count()&amp;gt;
&amp;lt;cfoutput&amp;gt;The keyword #form.keyword# comes up #res# time(s).&amp;lt;/cfoutput&amp;gt;
</code></pre>

<p>&lt;/cfif&gt;
</code></p>

<p><p></p>

<p>Note how I point to the key - that&rsquo;s actually an array. But MongoDB handles that just fine. The only issue I ran into was case sensitivity. You can see my original example was a bit simpler. To make it case insensitive I had to switch to a regex.</p>

<p><p></p>

<p>So that&rsquo;s all fine and good - but for deeper work you need to use what&rsquo;s called <a href="http://www.mongodb.org/display/DOCS/MapReduce">MapReduce</a>. This is&hellip; I don&rsquo;t know. It&rsquo;s insane Ninja Voodoo to me. My gut feeling is that it&rsquo;s something along the lines of&hellip;</p>

<p><p></p>

<ul>
<li>Here is an arbitrary function to run on each object...
<li>It outputs a basic stat
<li>And then I store those stats
<li>And then I query against that stat
</ul>

<p><p></p>

<p>That&rsquo;s a pretty poor explanation. Essentially it is a two step process. My understanding is that the &ldquo;reduce&rdquo; part is normally done behind the scenes on a schedule since it involves the most work. The reporting then is done against the reduced data so that it runs a lot quicker. Here is a example. (And thanks again to Marc Esher for producing an example for me.)</p>

<p><p></p>

<p><code></p>

<p>&lt;cfscript&gt;</p>

<pre><code>comments = application.mongo.getDBCollection( application.collectionName );

map = &quot;
    function() {
        if(&quot;&quot;ANALYSIS&quot;&quot; in this &amp;&amp; &quot;&quot;Topics&quot;&quot; in this.ANALYSIS) {
            for(var i=0; i&amp;lt;this.ANALYSIS.Topics.TopTopics.length;i++) {
                var topicOb = this.ANALYSIS.Topics.TopTopics[i];
                if(topicOb.Topic != null) {
                    emit(topicOb.Topic.Name, {count:1});
                }

            }
        }
    }   
&quot;;

reduce = &quot;
    function(key, emits){
        var total = 0;

        for( var i in emits ){
            total += emits[i].count;
        }
        return {count: total};
    }
&quot;;


result = comments.mapReduce( map=map, reduce=reduce, outputTarget=&quot;comment_topic_rank&quot;, options={} );

ranks = application.mongo.getDBCollection(&quot;comment_topic_rank&quot;);
sorted = ranks.find(sort={&quot;value.count&quot;=-1},limit=20);
</code></pre>

<p>&lt;/cfscript&gt;</p>

<p>&lt;h2&gt;Keyword Report&lt;/h2&gt;
&lt;table border=&ldquo;1&rdquo;&gt;
    &lt;tr&gt;
        &lt;th&gt;Keyword&lt;/th&gt;
        &lt;th&gt;Count&lt;/th&gt;
    &lt;/tr&gt;</p>

<p>&lt;cfloop index=&ldquo;item&rdquo; array=&ldquo;#sorted.asArray()#&rdquo;&gt;
    &lt;cfoutput&gt;
    &lt;tr&gt;
        &lt;td&gt;#item._id#&lt;/td&gt;
        &lt;td&gt;#numberFormat(item.value[&ldquo;count&rdquo;])#&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/cfoutput&gt;
&lt;/cfloop&gt;</p>

<p>&lt;/table&gt;<br />
</code></p>

<p><p></p>

<p>This template reports on all the topics in my database. While I had 44K comments, each comment had 1-N topics. This one will loop over each item, loop over each topic, and store the count. This gets stored into comment_topic_rank (the reduced data?) and once I have that, it&rsquo;s trivial to sort against. For folks curious about my stats, here is the report:</p>

<p><p></p>

<p><img src="http://www.coldfusionjedi.com/images/ScreenClip172.png" /></p>

<p><p></p>

<p>This takes about 8 seconds to generate - but again - I&rsquo;m regenerating the reduced data when I don&rsquo;t need to. And frankly - considering the amount of data it&rsquo;s parsing - that still seems rather fast. Here is another example that looks at the Mood data (how happy/sad are my comments):</p>

<p><p></p>

<p><code>
&lt;cfscript&gt;</p>

<pre><code>comments = application.mongo.getDBCollection( application.collectionName );

map = &quot;
    function() {
        if(&quot;&quot;ANALYSIS&quot;&quot; in this &amp;&amp; &quot;&quot;Styles&quot;&quot; in this.ANALYSIS) {
            emit(this.ANALYSIS.Styles.Polarity.Mean.Name, {count:1});
        }
    }   
&quot;;

reduce = &quot;
    function(key, emits){
        var total = 0;

        for( var i in emits ){
            total += emits[i].count;
        }
        return {count: total};
    }
&quot;;


result = comments.mapReduce( map=map, reduce=reduce, outputTarget=&quot;comment_mood_rank&quot;, options={} );

ranks = application.mongo.getDBCollection(&quot;comment_mood_rank&quot;);
sorted = ranks.find(sort={&quot;value.count&quot;=-1},limit=20);
</code></pre>

<p>&lt;/cfscript&gt;</p>

<p>&lt;h2&gt;Mood Report&lt;/h2&gt;
&lt;table border=&ldquo;1&rdquo;&gt;
    &lt;tr&gt;
        &lt;th&gt;Keyword&lt;/th&gt;
        &lt;th&gt;Count&lt;/th&gt;
    &lt;/tr&gt;</p>

<p>&lt;cfloop index=&ldquo;item&rdquo; array=&ldquo;#sorted.asArray()#&rdquo;&gt;
    &lt;cfoutput&gt;
    &lt;tr&gt;
        &lt;td&gt;#item._id#&lt;/td&gt;
        &lt;td&gt;#numberFormat(item.value[&ldquo;count&rdquo;])#&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/cfoutput&gt;
&lt;/cfloop&gt;</p>

<p>&lt;/table&gt;<br />
</code></p>

<p><p></p>

<p>Which results in&hellip;</p>

<p><p></p>

<p><img src="http://www.coldfusionjedi.com/images/ScreenClip173.png" /></p>

<p><p></p>

<p>All in all - pretty fascinating I think. Imagine how useful that would be to a company like Sony? Using OpenAmplify to parse comments as they come in real time, store them in MongoDB, and provide a live report of the mood on their forums. Even if a bit delayed, it could very well be a critical way to notice when something swings the mood. If customer service reps see a big drop, it could mean some breaking story (oh, like a security issue) that they need to address.</p>

<p><p></p>

<p>Anyway - I&rsquo;m pretty darn impressed by MongoDB and the CFMongoDB wrapper. Do I think I&rsquo;ll be using it soon in production? I don&rsquo;t know. I think in this use case it was incredibly well suited. I would have shot myself before attempting to convert that large structure into a set of tables. It&rsquo;s nice to know that when such an issue does rise again, I&rsquo;ll have a good tool to make use of.</p>

<h2>Some Final Notes</h2>

<ul>
<li>Stalk <a href="http://blog.mxunit.org/">Marc Esher</a>. No, seriously, do it. I've seen him present 3 times now. The first one was on continuous integration and Hudson. It changed my life. Seriously. The second time was this crap. Epic. Last time it was on ORM (and the issues you encounter). Not new to me, but his presentation did a damn good job of summarizing the issues. I've yet to see him give a bad presentation. Of course, now that I've said this I've probably created unrealistic expectations. ;)
<li>Run MongoDB at the command line and pay attention to it. You can actually output debug messages to the console while working and I found that to be very helpful to my testing.
<li>I've already linked to the MongoDB docs - but also check out their excellent <a href="http://cookbook.mongodb.org/">cookbook</a>. 
<li>Don't forget the report any issues you have with CFMongoDB. I found a few small bugs while running it so I made sure to actually report them on the Github site. It's amazing how few people actually bother to do so. As an open source developer, let me make it clear. <b>We can't fix bugs we don't know about.</b> 
</ul>

            </div>
        </div>

    </article>

		
    <section id="comments">
        <div id="disqus_thread">
            
<script>
var disqus_config = function () {

this.page.url = 'http://www.raymondcamden.com\/2011\/09\/02\/Finally-tried-a-NoSQL-server-and-its-kinda-cool'; 
this.page.identifier = '/?p=4351'; 

};

(function() { 
var d = document, s = d.createElement('script');

s.src = '//raymondcamden.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        </div>
    </section>
	
</section>

    <aside id="sidebar">

	<div class="widget-wrap">
		<h3 class="widget-title">
			Sponsors
		</h3>
		<div class="widget">
			<a href="http://www.fusion-reactor.com/?affiliate=raymondcamden"><img src="/images/frad150.png" title="FusionReactor"></a>
		</div>
	</div>

  	
    
<div class="widget-wrap">
    <h3 class="widget-title">
        Recents
    </h3>
    <div class="widget">
        <ul id="recent-post">
            
            <li>
                <div class="item-thumbnail">
                    <a href="http://www.raymondcamden.com/2011/09/02/Finally-tried-a-NoSQL-server-and-its-kinda-cool" class="thumbnail">
                    
                        <span style="background-image:url(http://www.raymondcamden.com//images/banners/comicbooks.jpg)" alt="Finally tried a NoSQL server... and it&#39;s kinda cool" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-category">
                        <a class="article-category-link" href="http://www.raymondcamden.com/categories/development">
                        Development
                        </a>
                    </p>
                    
                    <p class="item-title"><a href="http://www.raymondcamden.com/2016/02/22/building-a-twitter-bot-to-display-random-comic-book-covers" class="title">Building a Twitter bot to display random comic book covers</a></p>
                    <p class="item-date">
                        <time datetime="2016-02-22 10:42:00 -0700 -0700" itemprop="datePublished">2016-02-22</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="http://www.raymondcamden.com/2011/09/02/Finally-tried-a-NoSQL-server-and-its-kinda-cool" class="thumbnail">
                    
                        <span class="thumbnail-image thumbnail-none"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-category">
                        <a class="article-category-link" href="http://www.raymondcamden.com/categories/development">
                        Development
                        </a>
                    </p>
                    
                    <p class="item-title"><a href="http://www.raymondcamden.com/2016/02/18/creating-an-unread-count-for-a-static-site" class="title">Creating an unread count for a static site</a></p>
                    <p class="item-date">
                        <time datetime="2016-02-18 14:23:00 -0700 -0700" itemprop="datePublished">2016-02-18</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="http://www.raymondcamden.com/2011/09/02/Finally-tried-a-NoSQL-server-and-its-kinda-cool" class="thumbnail">
                    
                        <span style="background-image:url(http://www.raymondcamden.com//images/banners/phonegap-logo.png)" alt="Finally tried a NoSQL server... and it&#39;s kinda cool" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-category">
                        <a class="article-category-link" href="http://www.raymondcamden.com/categories/development">
                        Development
                        </a>
                    </p>
                    
                    <p class="item-title"><a href="http://www.raymondcamden.com/2016/02/17/my-phonegap-day-2016-presentation" class="title">My PhoneGap Day 2016 Presentation</a></p>
                    <p class="item-date">
                        <time datetime="2016-02-17 08:41:00 -0700 -0700" itemprop="datePublished">2016-02-17</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="http://www.raymondcamden.com/2011/09/02/Finally-tried-a-NoSQL-server-and-its-kinda-cool" class="thumbnail">
                    
                        <span class="thumbnail-image thumbnail-none"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-category">
                        <a class="article-category-link" href="http://www.raymondcamden.com/categories/coldfusion">
                        ColdFusion
                        </a>
                    </p>
                    
                    <p class="item-title"><a href="http://www.raymondcamden.com/2016/02/16/adobe-coldfusion-2016-released" class="title">Adobe ColdFusion 2016 Released</a></p>
                    <p class="item-date">
                        <time datetime="2016-02-16 05:35:00 -0700 -0700" itemprop="datePublished">2016-02-16</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="http://www.raymondcamden.com/2011/09/02/Finally-tried-a-NoSQL-server-and-its-kinda-cool" class="thumbnail">
                    
                        <span class="thumbnail-image thumbnail-none"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-category">
                        <a class="article-category-link" href="http://www.raymondcamden.com/categories/misc">
                        Misc
                        </a>
                    </p>
                    
                    <p class="item-title"><a href="http://www.raymondcamden.com/2016/02/15/missing-devnexus" class="title">Missing DevNexus</a></p>
                    <p class="item-date">
                        <time datetime="2016-02-15 14:44:00 -0700 -0700" itemprop="datePublished">2016-02-15</time>
                    </p>
                </div>
            </li>
            
        </ul>
    </div>
</div>


    


<div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/adoption">
                    adoption
                </a>
                <span class="category-list-count">13</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/books">
                    books
                </a>
                <span class="category-list-count">39</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/coldfusion">
                    coldfusion
                </a>
                <span class="category-list-count">3128</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/design">
                    design
                </a>
                <span class="category-list-count">32</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/development">
                    development
                </a>
                <span class="category-list-count">706</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/flex">
                    flex
                </a>
                <span class="category-list-count">189</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/games">
                    games
                </a>
                <span class="category-list-count">5</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/html5">
                    html5
                </a>
                <span class="category-list-count">273</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/javascript">
                    javascript
                </a>
                <span class="category-list-count">592</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/jquery">
                    jquery
                </a>
                <span class="category-list-count">329</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/misc">
                    misc
                </a>
                <span class="category-list-count">1157</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/mobile">
                    mobile
                </a>
                <span class="category-list-count">458</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/movies">
                    movies
                </a>
                <span class="category-list-count">31</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/music">
                    music
                </a>
                <span class="category-list-count">10</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/uncategorized">
                    uncategorized
                </a>
                <span class="category-list-count">13</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/categories/video-games">
                    video-games
                </a>
                <span class="category-list-count">74</span>
            </li>
            
        </ul>
    </div>
</div>



    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tags
    </h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/bluemix">
                    bluemix
                </a>
                <span class="category-list-count">21</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/cordova">
                    cordova
                </a>
                <span class="category-list-count">51</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/front-end-interview-questions">
                    front-end-interview-questions
                </a>
                <span class="category-list-count">3</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/harpjs">
                    harpjs
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/ionic">
                    ionic
                </a>
                <span class="category-list-count">66</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/mobilefirst">
                    mobilefirst
                </a>
                <span class="category-list-count">25</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/nodejs">
                    nodejs
                </a>
                <span class="category-list-count">3</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/phonegap">
                    phonegap
                </a>
                <span class="category-list-count">2</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/strongloop">
                    strongloop
                </a>
                <span class="category-list-count">10</span>
            </li>
            
            <li class="category-list-item">
                <a class="category-list-link" href="http://www.raymondcamden.com/tags/swift">
                    swift
                </a>
                <span class="category-list-count">1</span>
            </li>
            
        </ul>
    </div>
</div>



    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tag cloud
    </h3>
    <div class="widget tagcloud">
        
        <a href="http://www.raymondcamden.com/tags/bluemix" style="font-size: 12px;">bluemix</a>
        
        <a href="http://www.raymondcamden.com/tags/cordova" style="font-size: 12px;">cordova</a>
        
        <a href="http://www.raymondcamden.com/tags/front-end-interview-questions" style="font-size: 12px;">front-end-interview-questions</a>
        
        <a href="http://www.raymondcamden.com/tags/harpjs" style="font-size: 12px;">harpjs</a>
        
        <a href="http://www.raymondcamden.com/tags/ionic" style="font-size: 12px;">ionic</a>
        
        <a href="http://www.raymondcamden.com/tags/mobilefirst" style="font-size: 12px;">mobilefirst</a>
        
        <a href="http://www.raymondcamden.com/tags/nodejs" style="font-size: 12px;">nodejs</a>
        
        <a href="http://www.raymondcamden.com/tags/phonegap" style="font-size: 12px;">phonegap</a>
        
        <a href="http://www.raymondcamden.com/tags/strongloop" style="font-size: 12px;">strongloop</a>
        
        <a href="http://www.raymondcamden.com/tags/swift" style="font-size: 12px;">swift</a>
        
    </div>
</div>



	

    <div id="toTop" class="fa fa-chevron-up"></div>
</aside>

</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016
      Powered by <a href="//gohugo.io">Hugo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>.
    </div>
  </div>
</footer>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-70863-1', 'auto');
ga('send', 'pageview');
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="http://www.raymondcamden.com/fancybox/jquery.fancybox.pack.js"></script>
<script src="http://www.raymondcamden.com/js/script.js"></script>
<script src="http://www.raymondcamden.com/js/prism.js"></script>


</body>
</html>
